# %% Imports
import pandas as pd
from plotnine import *
from datetime import datetime
from pathlib import Path

output_dir = str(Path.home() / 'Downloads')

# %% [markdown] Ad-hoc data exporter for a given trace graph G
# Hint: Set a breakpoint in aws_trace_analyzer.py and debug a test case in aws_trace_analyzer_test.py.
# Breakpoint: https://github.com/anonymous/serverless-benchmarker/blob/c6241ad48d7f25fff56916d2948681d6613813e4/sb/aws_trace_analyzer.py#L226
# Sample test case: https://github.com/anonymous/serverless-benchmarker/blob/c6241ad48d7f25fff56916d2948681d6613813e4/tests/unit/aws_trace_analyzer_test.py#L97

# ```python
# data = []
# for n, a in G.nodes(data=True):
#     doc = a['doc']
#     data.append({'start_time': doc['start_time'], 'end_time': doc['end_time'], 'id': doc['id'], 'name': doc['name'], 'origin': doc.get('origin', None)})
# print(data)
# ```

# %% Prepare data
data = [{'start_time': 1619774396.615, 'end_time': 1619774396.625, 'id': '5382ac7a0b5c0ca3', 'name': 'aws-dev-lst', 'origin': 'AWS::Lambda::Function'}, {'start_time': 1619774396.602, 'end_time': 1619774396.627, 'id': '6fd8f7cf8343d129', 'name': 'aws-dev-lst', 'origin': 'AWS::Lambda'}, {'start_time': 1619774396.6160483, 'end_time': 1619774396.624469, 'id': 'ad840c6bc17444d1', 'name': 'DynamoDB', 'origin': None}, {'start_time': 1619774396.6222126, 'end_time': 1619774396.6244373, 'id': 'fdccada47aa827ec', 'name': 'unmarshal', 'origin': None}, {'start_time': 1619774396.6160514, 'end_time': 1619774396.6160738, 'id': '797d67019e262510', 'name': 'marshal', 'origin': None}, {'start_time': 1619774396.6160777, 'end_time': 1619774396.6221964, 'id': '3df5f9c655015812', 'name': 'attempt', 'origin': None}, {'start_time': 1619774396.6161628, 'end_time': 1619774396.6162694, 'id': '351bda5c1ff106f5', 'name': 'request', 'origin': None}, {'start_time': 1619774396.616274, 'end_time': 1619774396.6221313, 'id': 'aa6d262e41200796', 'name': 'response', 'origin': None}, {'start_time': 1619774396.595, 'end_time': 1619774396.636, 'id': '26116a4548cea1ff', 'name': 'dev-aws/dev', 'origin': 'AWS::ApiGateway::Stage'}, {'start_time': 1619774396.597, 'end_time': 1619774396.626, 'id': '045739a66c26a771', 'name': 'Lambda', 'origin': None}, {'start_time': 1619774396.6160483, 'end_time': 1619774396.624469, 'id': '36d36c7d1e023ab1', 'name': 'DynamoDB', 'origin': 'AWS::DynamoDB::Table'}]
data = [{'start_time': 1619798933.143, 'end_time': 1619798933.192, 'id': '4d980bdff4925ff3', 'name': 'dev-realworld/dev', 'origin': 'AWS::ApiGateway::Stage'}, {'start_time': 1619798933.146, 'end_time': 1619798933.1929998, 'id': '703c861642152c04', 'name': 'Lambda', 'origin': None}, {'start_time': 1619798933.1539984, 'end_time': 1619798933.1899111, 'id': '6929d85046522c18', 'name': 'realworld-dev-getArticle', 'origin': 'AWS::Lambda::Function'}, {'start_time': 1619798933.148, 'end_time': 1619798933.191, 'id': '5d834446654927aa', 'name': 'realworld-dev-getArticle', 'origin': 'AWS::Lambda'}, {'start_time': 1619798933.1895688, 'end_time': 1619798933.1898685, 'id': '8e125444fc699025', 'name': 'Overhead', 'origin': None}, {'start_time': 1619798933.1541004, 'end_time': 1619798933.1895444, 'id': '8be3f30b541b504a', 'name': 'Invocation', 'origin': None}, {'start_time': 1619798933.182, 'end_time': 1619798933.188, 'id': '1feda8681662ac76', 'name': 'DynamoDB', 'origin': None}, {'start_time': 1619798933.155, 'end_time': 1619798933.169, 'id': 'bb724339bb4beb95', 'name': 'DynamoDB', 'origin': None}, {'start_time': 1619798933.17, 'end_time': 1619798933.181, 'id': 'e08d1a8a5b433a45', 'name': 'DynamoDB', 'origin': None}, {'start_time': 1619798933.17, 'end_time': 1619798933.181, 'id': '0b7978ca39d26d6a', 'name': 'DynamoDB', 'origin': 'AWS::DynamoDB::Table'}, {'start_time': 1619798933.155, 'end_time': 1619798933.169, 'id': '1d958aa23039fef5', 'name': 'DynamoDB', 'origin': 'AWS::DynamoDB::Table'}, {'start_time': 1619798933.182, 'end_time': 1619798933.188, 'id': '26c35e730641aecc', 'name': 'DynamoDB', 'origin': 'AWS::DynamoDB::Table'}]

# exp31/hello-retail/logs/2021-04-30_14-15-59 trace_id=1-608c1487-8892c4a7bc5e24a223902a15
# NOTE: might want to disable derived segments because they are basically duplicates without extra value cluttering the graph
data = [{'start_time': 1619793031.3149815, 'end_time': 1619793031.4671524, 'id': '631f5d606e888e41', 'name': 'hello-retail-product-photos-receive-dev-receive', 'origin': 'AWS::Lambda::Function'}, {'start_time': 1619793031.309, 'end_time': 1619793031.469, 'id': '7d9c12c118b4f3d1', 'name': 'hello-retail-product-photos-receive-dev-receive', 'origin': 'AWS::Lambda'}, {'start_time': 1619793031.4664514, 'end_time': 1619793031.4671109, 'id': '5062f690c6b1fa52', 'name': 'Overhead', 'origin': None}, {'start_time': 1619793031.3150375, 'end_time': 1619793031.4664235, 'id': 'ae39ae5c436e8ba2', 'name': 'Invocation', 'origin': None}, {'start_time': 1619793031.428, 'end_time': 1619793031.464, 'id': 'ad3c751b80d60e2c', 'name': 'stepfunctions', 'origin': None}, {'start_time': 1619793031.333, 'end_time': 1619793031.427, 'id': 'd6ca7ce23364dc40', 'name': 'S3', 'origin': None}, {'start_time': 1619793031.317, 'end_time': 1619793031.332, 'id': 'c8bca9a21c281bd8', 'name': 'DynamoDB', 'origin': None}, {'start_time': 1619793031.301, 'end_time': 1619793031.47, 'id': '2ca32caec014a2af', 'name': 'dev-hello-retail-product-photos-receive/dev', 'origin': 'AWS::ApiGateway::Stage'}, {'start_time': 1619793031.304, 'end_time': 1619793031.4689999, 'id': '72f699bfc74f8747', 'name': 'Lambda', 'origin': None}, {'start_time': 1619793031.317, 'end_time': 1619793031.332, 'id': '1e0ec29a0256f964', 'name': 'DynamoDB', 'origin': 'AWS::DynamoDB::Table'}, {'start_time': 1619793031.333, 'end_time': 1619793031.427, 'id': '2c0f4f7a37bc23ba', 'name': 'S3', 'origin': 'AWS::S3::Bucket'}, {'start_time': 1619793031.428, 'end_time': 1619793031.464, 'id': '0a05296521010b76', 'name': 'stepfunctions', 'origin': 'AWS::stepfunctions'}]

# exp31/faas-migration/Event-Processing/Lambda/logs/2021-04-30_05-34-22 trace_id=1-608b975f-82c9cf3915cf8d7c1093ada7
data = [{'start_time': 1619760991.88, 'end_time': 1619760991.919, 'id': '5d98752257e51041', 'name': 'event-processing-dev-ingest', 'origin': 'AWS::Lambda'}, {'start_time': 1619760991.875, 'end_time': 1619760991.92, 'id': '7ddca1046ef1985c', 'name': 'Lambda', 'origin': None}, {'start_time': 1619760991.8856246, 'end_time': 1619760991.9165885, 'id': '4c57c76218613840', 'name': 'event-processing-dev-ingest', 'origin': 'AWS::Lambda::Function'}, {'start_time': 1619760991.9161391, 'end_time': 1619760991.9165547, 'id': '0d431e9961cd6461', 'name': 'Overhead', 'origin': None}, {'start_time': 1619760991.885675, 'end_time': 1619760991.9160957, 'id': 'ce71a9e6624497a6', 'name': 'Invocation', 'origin': None}, {'start_time': 1619760991.886, 'end_time': 1619760991.915, 'id': '62a5b8bdc147d7dd', 'name': 'SNS', 'origin': None}, {'start_time': 1619760991.926, 'end_time': 1619760991.931, 'id': '6d05055c18416f23', 'name': 'event-processing-dev-format_state_change', 'origin': 'AWS::Lambda'}, {'start_time': 1619760991.886, 'end_time': 1619760991.915, 'id': '3d46a9ec2871f006', 'name': 'SNS', 'origin': 'AWS::SNS'}, {'start_time': 1619760991.958, 'end_time': 1619760991.998, 'id': '1ac8a21aee22b4e3', 'name': 'Attempt #1', 'origin': None}, {'start_time': 1619760991.926, 'end_time': 1619760991.958, 'id': '09b064d0dfd77159', 'name': 'Dwell Time', 'origin': None}, {'start_time': 1619760991.873, 'end_time': 1619760991.92, 'id': '59d284e254912526', 'name': 'dev-event-processing/dev', 'origin': 'AWS::ApiGateway::Stage'}, {'start_time': 1619760991.9685893, 'end_time': 1619760991.9956906, 'id': '206c8bde4844d1da', 'name': 'event-processing-dev-format_state_change', 'origin': 'AWS::Lambda::Function'}, {'start_time': 1619760991.9686358, 'end_time': 1619760991.9949584, 'id': '0968878f47f64916', 'name': 'Invocation', 'origin': None}, {'start_time': 1619760991.969, 'end_time': 1619760991.994, 'id': '4e389a109ab7353c', 'name': 'SQS', 'origin': None}, {'start_time': 1619760991.9949834, 'end_time': 1619760991.9956527, 'id': 'e4546d09dde35985', 'name': 'Overhead', 'origin': None}, {'start_time': 1619760991.969, 'end_time': 1619760991.994, 'id': '1a3fbbb81821e5dd', 'name': 'SQS', 'origin': 'AWS::SQS::Queue'}, {'start_time': 1619760991.969, 'end_time': 1619760991.994, 'id': '02b8700a2f5e645f', 'name': 'QueueTime', 'origin': None}]

# tmp
data = [{'start_time': 1619745867.136, 'end_time': 1619745873.151, 'id': '66a701ea00f13756', 'name': 'thumbnail-generator-dev-thumbnail-generator', 'origin': 'AWS::Lambda::Function'}, {'start_time': 1619745865.701, 'end_time': 1619745873.154, 'id': '5ab2cea45ed06285', 'name': 'Attempt #1', 'origin': None}, {'start_time': 1619745871.258, 'end_time': 1619745872.406, 'id': '774fc13d83a0ed76', 'name': 'S3', 'origin': None}, {'start_time': 1619745865.963, 'end_time': 1619745867.134, 'id': '155dd1d93cb6eebc', 'name': 'Initialization', 'origin': None}, {'start_time': 1619745872.975, 'end_time': 1619745873.096, 'id': '3b8d92366f609d77', 'name': 'S3', 'origin': None}, {'start_time': 1619745865.102, 'end_time': 1619745865.135, 'id': '282f89ec300208b6', 'name': 'thumbnail-generator-dev-upload', 'origin': 'AWS::Lambda::Function'}, {'start_time': 1619745865.095, 'end_time': 1619745865.137, 'id': '39ea347bc111e756', 'name': 'thumbnail-generator-dev-upload', 'origin': 'AWS::Lambda'}, {'start_time': 1619745865.107, 'end_time': 1619745865.134, 'id': '7f360d2b0849b0b8', 'name': 'S3', 'origin': None}, {'start_time': 1619745865.09, 'end_time': 1619745865.139, 'id': '3b332285d6d1deb0', 'name': 'Lambda', 'origin': None}, {'start_time': 1619745865.605, 'end_time': 1619745865.626, 'id': '3f1628732d3d3d5a', 'name': 'thumbnail-generator-dev-thumbnail-generator', 'origin': 'AWS::Lambda'}, {'start_time': 1619745865.605, 'end_time': 1619745865.701, 'id': '53482ff51aff4e43', 'name': 'Dwell Time', 'origin': None}, {'start_time': 1619745865.087, 'end_time': 1619745865.139, 'id': '400e33ea1e0eb8bf', 'name': 'dev-thumbnail-generator/dev', 'origin': 'AWS::ApiGateway::Stage'}, {'start_time': 1619745872.975, 'end_time': 1619745873.096, 'id': '2d6aef2b3f9e5d54', 'name': 'S3', 'origin': 'AWS::S3::Bucket'}, {'start_time': 1619745871.258, 'end_time': 1619745872.406, 'id': '09c714fb0a837a4e', 'name': 'S3', 'origin': 'AWS::S3::Bucket'}, {'start_time': 1619745865.107, 'end_time': 1619745865.134, 'id': '260ce4131a3f8e76', 'name': 'S3', 'origin': 'AWS::S3::Bucket'}]

# thumbnail_generator (used in test case, the one with viz): https://github.com/perfkit/serverless-benchmarker/tree/master/tests/fixtures/aws_trace_analyzer/thumbnail_app
data = [{'start_time': 1606220832.0, 'end_time': 1606220837.766, 'id': '7727af9f20ffa9ff', 'name': 'production-thumbnail-generator/production', 'origin': 'AWS::ApiGateway::Stage'}, {'start_time': 1606220832.004, 'end_time': 1606220837.766, 'id': '136a17265b0ba125', 'name': 'Lambda', 'origin': None}, {'start_time': 1606220832.037, 'end_time': 1606220837.764, 'id': '09cf64b5fc54574f', 'name': 'thumbnail-generator-production-upload', 'origin': 'AWS::Lambda'}, {'start_time': 1606220840.361, 'end_time': 1606220846.919, 'id': '25b1475b605b5ae7', 'name': 'thumbnail-generator-production-thumbnail-generator', 'origin': 'AWS::Lambda::Function'}, {'start_time': 1606220838.835, 'end_time': 1606220846.963, 'id': '1a4bad45b9acd2a6', 'name': 'Attempt #1', 'origin': None}, {'start_time': 1606220846.542, 'end_time': 1606220846.779, 'id': '765d790277f647e3', 'name': 'S3', 'origin': None}, {'start_time': 1606220839.172, 'end_time': 1606220840.358, 'id': '7fdf67c6090e62ba', 'name': 'Initialization', 'origin': None}, {'start_time': 1606220844.561, 'end_time': 1606220845.808, 'id': '51522c8864fd913b', 'name': 'S3', 'origin': None}, {'start_time': 1606220835.429, 'end_time': 1606220837.762, 'id': '6fc3c3c212df370e', 'name': 'thumbnail-generator-production-upload', 'origin': 'AWS::Lambda::Function'}, {'start_time': 1606220837.335, 'end_time': 1606220837.677, 'id': '7afdc379e1199035', 'name': 'S3', 'origin': None}, {'start_time': 1606220832.471, 'end_time': 1606220835.427, 'id': '554ab0426b358e6b', 'name': 'Initialization', 'origin': None}, {'start_time': 1606220835.696, 'end_time': 1606220837.175, 'id': '632eaa39499ace4e', 'name': 'S3', 'origin': None}, {'start_time': 1606220838.776, 'end_time': 1606220838.806, 'id': '1bd28856f2142fa1', 'name': 'thumbnail-generator-production-thumbnail-generator', 'origin': 'AWS::Lambda'}, {'start_time': 1606220838.776, 'end_time': 1606220838.835, 'id': '64838b5f69be8e41', 'name': 'Dwell Time', 'origin': None}, {'start_time': 1606220844.561, 'end_time': 1606220845.808, 'id': '38b0fdb635ab8a5b', 'name': 'S3', 'origin': 'AWS::S3::Bucket'}, {'start_time': 1606220846.542, 'end_time': 1606220846.779, 'id': '28def5270dc088dd', 'name': 'S3', 'origin': 'AWS::S3::Bucket'}, {'start_time': 1606220835.696, 'end_time': 1606220837.175, 'id': '22df469b17cec908', 'name': 'S3', 'origin': 'AWS::S3::Bucket'}, {'start_time': 1606220837.335, 'end_time': 1606220837.677, 'id': '21378a100add4857', 'name': 'S3', 'origin': 'AWS::S3::Bucket'}]

df = pd.DataFrame(data)
df = df.sort_values(['start_time', 'end_time'], ascending=False).reset_index(drop = True)
df['id'] = pd.Categorical(df.id, categories=pd.unique(df.id))
df['label'] = df['name'] + ' (' + df['origin'].astype(str) + ')'
# Convert to datetime
timeformat = '%H:%M:%S'  # milliseconds .%f
df['start_time_ts'] = df['start_time'].apply(pd.to_datetime, unit='s')
df['end_time_ts'] = df['end_time'].apply(pd.to_datetime, unit='s')
df.head()

# %% Plot trace view
x_max = df['end_time'].max()
x_label = x_max + 0.01
x_min = df['start_time'].min()

p = (ggplot(df)
    # Range strip
    + geom_segment(
        aes(x='start_time', xend='end_time', y='id', yend='id'),
        size=4,
        color='#a7a9ac'
    )
    + geom_text(
        aes(x=x_label, y='id', label='label'),
        size=5,
        fontweight='bold'
    )
    + scale_x_continuous(limits=(x_min-0.001, x_label+0.008), labels=lambda l: [datetime.utcfromtimestamp(v).strftime(timeformat) for v in l])
    + xlab(f"start_time={datetime.utcfromtimestamp(x_min).isoformat(timespec='milliseconds')}\nend_time={datetime.utcfromtimestamp(x_max).isoformat(timespec='milliseconds')}\nduration={x_max-x_min}s")
)

p.save(path=output_dir, filename=f"trace_map.pdf", width=24, height=12, units='cm')
